<html>

<script src="datapfos.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script> 



<script>
 var histCrests=[];
 var probOfExceed=[];
 var probOfExceedFS=[];
 var data=[];
 var layout; 
 var defaultAnnotations = []; // holds default annotations e.g., action height 
 var extraAnnotations=[]; //for adding annotations for POEs
 var actionHeight; //global for use in poeFS function
 var defaultPOE=[];
 var histCrestAnnotations=[];
 function preLoad(){

  var req = new XMLHttpRequest();
  req.open('GET','https://cors-anywhere.herokuapp.com/https://www.weather.gov/source/aprfc/histCrestsfgf.json',true);
  req.addEventListener('load',function(){
   if(req.status >= 200 && req.status < 400){
    var json = (JSON.parse(req.responseText)).features;
    for (var i=0;i<json.length;i++)
     histCrests[i] = json[i].properties;
   }
   else
    console.log("had an error");
  });
  req.send();
  var req2 = new XMLHttpRequest();
  req2.open('GET','https://cors-anywhere.herokuapp.com/https://www.weather.gov/source/ncrfc/CS_distributions.json',true);
  req2.addEventListener('load',function(){
   if(req2.status >= 200 && req2.status < 400){
    probOfExceedFS = JSON.parse(req2.responseText);
   }
   else
    console.log("had a problem with grabbing from NCRFC");
  });
  req2.send();
 
  var req3 = new XMLHttpRequest();
  req3.open('GET','https://cors-anywhere.herokuapp.com/https://www.weather.gov/source/ncrfc/CS_percentiles.json',true);
  req3.addEventListener('load',function(){
   if(req3.status >= 200 && req3.status < 400){
    probOfExceed = JSON.parse(req3.responseText);
    let myId = getUrlVars()["id"];
    if(getUrlVars()["id"]){
     console.log("Urlvars id is "+myId);
     for(let i=0;i<riverPoints.length;i++){
      if((riverPoints[i].id).toLowerCase() == getUrlVars()["id"].toLowerCase()){
       makeBox("holder",riverPoints[i].name,riverPoints[i].id);
       break;
      }
     }
    }
   }
   else
    console.log("had problem grabbing percentiles");
  });
  req3.send();
 }

 document.addEventListener("DOMContentLoaded", preLoad);

 /*build this out to work for other WFOs? Just pass the WFO into the URL? */
 function getUrlVars(){
  var vars = [], hash;
  var hashes = window.location.href.slice(window.location.href.indexOf('?')+1).split('&');
  for(let i=0; i<hashes.length;i++){
   hash = hashes[i].split('=');
   vars.push(hash[0]);
   vars[hash[0]]=hash[1];
  }
  return vars;
 }

 function makeBox(point,pointName,pointID){
  var req = new XMLHttpRequest();
  var reqLink = "https://water.weather.gov/ahps2/hydrograph_to_xml.php?output=xml&gage="+pointID;
  req.open('GET',reqLink,true);
  req.addEventListener('load', function(){
   if (req.status == 200){
    parser = new DOMParser();
    xmlDoc = parser.parseFromString(req.responseText, "text/xml");
    let sigStages = xmlDoc.querySelector("sigstages");
    actionHeight = parseInt(sigStages.querySelector("action").textContent);
    let minorHeight = parseInt(sigStages.querySelector("flood").textContent);
    let moderateHeight = parseInt(sigStages.querySelector("moderate").textContent);
    let majorHeight = parseInt(sigStages.querySelector("major").textContent);
    let observed = parseInt((xmlDoc.querySelector("observed datum primary")).textContent);
    let dateObserved = new Date((xmlDoc.querySelector("observed datum valid")).textContent);
    console.log("observed is "+observed);
    setGraphParams(point,pointName,pointID,actionHeight,minorHeight,moderateHeight,majorHeight,observed,dateObserved);
   }
   else
    console.log("got an error");
  });
  req.send();
 }

 function setHistoricCrests(pointID){
  histCrestAnnotations=[];
  let i=0; let found=false;
  while(i<histCrests.length && !found){
   if((histCrests[i].gage).toUpperCase() == pointID.toUpperCase())
    found=true;
   else
    i++;
  }
  if(found){
   for(let j=0;j<histCrests[i].historicCrests.length;j++){
    let height=Number(histCrests[i].historicCrests[j].height);
    let year = Number((histCrests[i].historicCrests[j].day).slice(-4));
    //separate annotation for the line so it goes to the y axis...?
    
    let newAnnotation0 = {xref: 'paper',yref:'y',x:0.99,y:height,textangle:0,yanchor:'middle',xanchor:'right',text:'<b>'+height+'</b>',showarrow:false,hoverinfo:'none',textposition:'top right',font: {color:'black',size:15,family: 'Arial,Helvetica, sans serif', weight:900}};
    let newAnnotation1 = {xref: 'paper',yref:'y',x:0.99,y:height,textangle:0,yanchor:'middle',xanchor:'left',text:'<b>\u02D7</b>',showarrow:false,hoverinfo:'none',textposition:'top right',font: {color:'black',size:15,family: 'Arial,Helvetica, sans serif', weight:900}};
    let newAnnotation2 = {xref: 'paper',yref:'y',x:1,y:height,textangle:0,yanchor:'middle',xanchor:'left',text:'<b>'+year+'</b>',showarrow:false,hoverinfo:'none',textposition:'top left', font: {color:'black',size:15,family: 'Arial,Helvetica,sans serif',weight:900}};
    histCrestAnnotations.push(newAnnotation0);
    histCrestAnnotations.push(newAnnotation1);
    histCrestAnnotations.push(newAnnotation2);
   } 
  }
 }
    
 /* format data for POEs for a point */
 function setProbOfExceed(pointID){
  defaultPOE = [];
  let i=0; let found=false;
  while(i<probOfExceed.length && !found){
   if((probOfExceed[i].id).toUpperCase() == pointID.toUpperCase())
    found=true;
   else
    i++;
  }
  let prev = -9999;
  if(found){
   for(let j=0;j<probOfExceed[i].exceedance.length;j++){
    let height = (Number(probOfExceed[i].exceedance[j].height)).toFixed(1);
    let percent = Number(probOfExceed[i].exceedance[j].percent);
    defaultPOE.push({'percent':percent,'height':height});
    let newAnnotation = {xref: 'paper',yref:'y',x:0.5,y:height,textangle:0,yanchor:'middle',text:'<b>'+height+' ft\u2014\u2014\u2014\u2014\u2014\u2014'+percent+'%</b>',showarrow:false,hoverinfo:'none',textposition:'top left',font: {color:'navy',size:15,family: 'Arial,Helvetica, sans serif', weight:900}};
    if (height != prev){
   //  data.push(exceed0);
     defaultAnnotations.push(newAnnotation);
    }
    prev=height;
   }
  }
 }
 
 /* format data for full spectrum POEs for a point */
 function setProbOfExceedFS(pointID,x0=null,x1=null){
  console.log("calling setprobofExceedFS");
  console.log("x0 is "+x0+" and x1 is "+x1);
  let i=0; let found=false;
  let dataFS = [];
  //find the right station
  while(i<probOfExceedFS.length && !found){
   if((probOfExceedFS[i].id).toUpperCase() == pointID.toUpperCase())
    found=true;
   else
    i++;
  }
  if (!found)
   return;

  console.log("found it");
  let prev = -9999;
  for (j=0; j<probOfExceedFS[i].exceedance.length;j++){
   let height = (Number(probOfExceedFS[i].exceedance[j].height)).toFixed(1);
   let percent = Math.round(Number(probOfExceedFS[i].exceedance[j].percent));
   let newAnnotation = {xref: 'paper',yref:'y',x:0.5,y:height,textangle:0,yanchor:'middle',text:'<b>'+height+' ft\u2014\u2014\u2014\u2014\u2014\u2014'+percent+'%</b>',showarrow:false,hoverinfo:'none',textposition:'top left',font: {color:'navy',size:15,family: 'Arial,Helvetica, sans serif'}};
   if (height == prev || Math.abs(height-prev) < 1){ //check so that we don't stack stuff... when you get to higher percentages heights tend to repeat
    prev=height;
    continue;
   }
   if (x0 || x1){  //as in, we've zoomed
    console.log("in so far...x0 is "+x0+" and x1 is "+x1);
    if (x1 - x0 < 20){
     console.log("this is zoomed all the way in");
     if (height != prev){
      let redundant = false; let k=0;
      while(!redundant && k<defaultPOE.length){
       if (defaultPOE[k].height == height || defaultPOE[k].percent == percent)
        redundant = true;
       k++;
      }
      if(redundant)
       continue;
      extraAnnotations.push(newAnnotation);
      prev = height;
      continue;
     }
    }
   }
   if (percent > 80 ) //we already get 90% from the standard POE
    break;
   let redundant = false;let k=0;
    while (!redundant && k<defaultPOE.length){
     if (Math.abs(defaultPOE[k].height - height) < 1 || Math.abs(defaultPOE[k].percent - percent) < 2)
      redundant = true;
     k++;
    }
    if(redundant)
     continue;
    if (percent > 70 || height < actionHeight){ //only do every 10th FS POE for the levels that really don't matter
     if (j%10 == 0){
      extraAnnotations.push(newAnnotation);
      prev = height;
     }
    }
    else{
     if (!(x0 || x1)){
      if (j%7 == 0){
       extraAnnotations.push(newAnnotation);
       prev = height;
      }
     }
     else{ if (x1-x0 > 70){
       if (j%7 == 0){
        extraAnnotations.push(newAnnotation);
        prev = height;
       }
      }
      else if (x1-x0 > 60){
       if (j%6 == 0){
        extraAnnotations.push(newAnnotation);
        prev = height;
       }
      }
      else if (x1-x0 > 50){
       if (j%5 == 0){
        extraAnnotations.push(newAnnotation);
        prev = height;
       }
      }
      else if (x1-x0 > 40){
       if (j%4 == 0){
        extraAnnotations.push(newAnnotation);
        prev = height;
       }
      }
      else if (x1-x0 > 30){
       if (j%3 == 0){
        extraAnnotations.push(newAnnotation);
        prev = height;
       }
      }
      else if (x1-x0 > 20){
       if (j%2 == 0){
        extraAnnotations.push(newAnnotation);
        prev = height;
       }
      }
 //prob want to put this above so you get everything all the way zoomed in
      else{
        extraAnnotations.push(newAnnotation);
        prev = height;
      }
     }
    }
   }
  return dataFS;
 }

 function setGraphParams(point,pointName,pointID,actionHeight,minorHeight,moderateHeight,majorHeight,observedHeight,dateObserved){
  data = [];
  defaultAnnotations = [];
  
  tester = document.getElementById('highContainer');
  //find station in probOfExceed
  
  //setProbOfExceed(pointID);

  let k=0; found=false;
  while(k<histCrests.length && !found){
   if ((histCrests[k].gage).toUpperCase() == pointID.toUpperCase())
    found=true;
   else
    k++;
  }
//need exception handling for this stuff
 if (histCrests[k].historicCrests[0].height != "null"){
  var recordHeight = Number(histCrests[k].historicCrests[0].height); var recordDay = histCrests[k].historicCrests[0].day;
  setHistoricCrests(pointID);
 }
 var record = {
  showlegend: false,
   x: [0, 1], y: [recordHeight,recordHeight], mode: 'lines', hoverinfo:"none", line: {width: 1, dash: 'dot', color: 'rgb(0,0,0)'}
 };
 defaultAnnotations.push({xref: 'paper',yref:'y',x:0.3, y:recordHeight, xanchor: 'left', textangle: 0, yanchor:'middle',text: '<b>Record '+recordHeight+' ft '+ recordDay+'</b>', showarrow:false,hoverinfo:'none',textposition:'top left',bgcolor:'white',font: { color: 'black', size:15, family: 'Arial, Helvetica, sans serif'},
 });
  var action = {
   showlegend: false,hoverinfo:'none',
   x: [0, 1], y: [actionHeight,actionHeight], mode: 'lines', 
   line: { color: 'rgb(158,191,57)', width: 1}
  };
  defaultAnnotations.push({xref: 'paper',yref: 'y', x:0, y: actionHeight, xanchor: 'left', textangle: 0, yanchor:'middle',text: '<b>Action ('+actionHeight+' ft)</b>',showarrow:false,hoverinfo:'none',textposition:'top left',bgcolor:'rgb(158,191,57)',bordercolor:'rgb(0,0,0)',font: { color: "white", size:15, family: 'Arial,Helvetica,sans serif'}});
  var minor = {
   showlegend: false,hoverinfo:'none',
   x: [0,1], y: [minorHeight,minorHeight], mode: 'lines',
   line: { color: 'rgb(237,176,7)', width: 1}
  };
  defaultAnnotations.push({xref: 'paper',yref: 'y', x:0.1, y: minorHeight, xanchor: 'left', textangle: 0, yanchor:'middle',text: '<b>Minor ('+minorHeight+' ft)</b>',showarrow:false,hoverinfo:'none',textposition:'top left',bgcolor:'rgb(237,176,7)',bordercolor:'rgb(0,0,0)',font: { color: "white", size:15, family: 'Arial,Helvetica,sans serif'}});
  var moderate = {
   showlegend: false, hoverinfo:'none',
 x: [0, 1], y: [moderateHeight,moderateHeight],mode: 'lines',
   line: { color: 'rgb(237,53,17)', width: 1}
  };
  defaultAnnotations.push({xref: 'paper',yref: 'y', x:0, y: moderateHeight, xanchor: 'left', textangle: 0, yanchor:'middle',text: '<b>Moderate ('+moderateHeight+' ft)</b>',showarrow:false,hoverinfo:'none',textposition:'top left',bgcolor:'rgb(237,53,17)',bordercolor:'rgb(0,0,0)',font: { color: "white", size:15, family: 'Arial,Helvetica,sans serif'}});
  var major = {
   showlegend: false,hoverinfo:'none',
   x: [0,1], y: [majorHeight,majorHeight], mode: 'lines',
   line: { color: 'rgb(179,57,219)',width: 1}
  };
  defaultAnnotations.push({xref: 'paper',yref: 'y', x:0.1, y: majorHeight, xanchor: 'left', textangle: 0, yanchor:'middle',text: '<b>Major ('+majorHeight+' ft)</b>',showarrow:false,hoverinfo:'none',textposition:'top left',bgcolor:'rgb(179,57,219)',bordercolor:'rgb(0,0,0)',font: { color: "white", size:15, family: 'Arial,Helvetica,sans serif'}});
  data.push(action,minor,moderate,major,record);
  
  //figure out y ranges
  layout = {
  title: { text: '<span style=\'font-size:17;font-weight:bold;color:black;\'>2020 Spring Flood Outlook for '+pointName+'</span><br><span style=\'color:black;font-size:14;padding-bottom:30px\'>Valid 01-27-2020 through 05-19-2020</span><br><span style=\'color:navy;font-size:15;font-weight:bold;\'> % Chance of reaching or exceeding this level</span>', font:{family: 'Arial,Helvetica,sans serif'}},
   traceorder: 'grouped', dragmode: 'pan',
   margin: { l: 50, r:50, t:150 },
   yaxis: {range: [0.8*actionHeight,1.1*(Math.max(recordHeight,majorHeight))], title: '<b>River Stage (ft)</b>', ticks: 'outside', linecolor: 'black', linewidth: 2, mirror: true, tickfont: { family: 'Arial', size: 14},font:{size:16,color:'black',family:'Arial,Helvetica,sans serif'} },
   xaxis: {fixedrange:true, showgrid: false, showline: true, linecolor: 'black', linewidth: 2, mirror: true, showticklabels: false,range: [0,1] },
   //xaxis2: { showgrid: true, range: [0,1] },
   legend: {bgcolor: '#E2E2E2',bordercolor:'black',borderwidth:2},
   images: [
    {x:1,y:1.01,xref:'paper',xanchor:'right',yref:'paper',yanchor:'bottom',sizex:0.2,sizey:0.2,source:'https://cors-anywhere.herokuapp.com/https://www.weather.gov/images/aprfc/nwslogo.gif'}, 
    {x:0,y:1.01,xref:'paper',xanchor:'left',yref:'paper',yanchor:'bottom',sizex:0.2,sizey:0.2,source:'https://cors-anywhere.herokuapp.com/https://www.weather.gov/images/aprfc/NOAA_logo.png'}]
  };
   defaultAnnotations.push(
   //{ xref: 'paper', yref: 'paper', x: 1, xanchor: 'left', y: 1, textangle:0, yanchor: 'middle', text: 'Probability of Exceedence', showarrow: false },
   { xref: 'paper',yref: 'paper',x: 0.01,y:0.04, xanchor: 'left',textangle:0,yanchor: 'middle',text: '<b>River Level: '+observedHeight+' ft as of '+dateObserved+'</b> ',showarrow: false,hoverinfo:'none' },
   { xref: 'paper',x:1.01,y:moderateHeight, xanchor: 'left',yanchor:'top',textangle:-90,text:'<b>Notable Crests</b>',showarrow:false,hoverinfo:'none',font:{size:16,color:'black',family:'Arial,Helvetica,sans serif'}}
   );
  

   setProbOfExceed(pointID);
  makeGraph(tester,layout,pointID);
 }
 
 function makeGraph(target,layout,pointID,x0=null,x1=null){
  console.log("calling MakeGraph");
  extraAnnotations = [];
  let dataFS = setProbOfExceedFS(pointID,x0,x1);
  let finalData = data.concat(dataFS);
  let annotations = defaultAnnotations.concat(extraAnnotations);
  annotations = annotations.concat(histCrestAnnotations);
  layout.annotations = annotations;
   
  Plotly.newPlot(target, finalData, layout, {responsive:true,scrollZoom:true,modeBarButtonsToRemove: ['select2d','pan2d','lasso2d','hoverClosestCartesian','hoverCompareCartesian','toggleSpikelines']});

 target.on('plotly_relayout',
  function(eventdata){
//   document.body.style.overflow = 'hidden';
   let x0=parseInt(eventdata['xaxis.range[0]']); let x1 = parseInt(eventdata['xaxis.range[1]']);
   let y0=parseInt(eventdata['yaxis.range[0]']); let y1 = parseInt(eventdata['yaxis.range[1]']);
   //makeGraph(target,layout,pointID,x0,x1);
   makeGraph(target,layout,pointID,y0,y1);
 //  document.body.style.overflow = 'visible';
   
  });
 target.on('plotly_click',
  function(eventdata){
   console.log('click registered');
  // let mydata = JSON.parse(eventdata);
   //alert('eventdata is '+mydata);
  });
 }

</script>









  <section id="graphicHome">
   <div style="height:800px; padding-right:130px;" id="highContainer"></div>
   <!--div id="highContainer"></div-->
  </section>
  <div style="clear:both"></div> 

 </body>
</html>


</html>
