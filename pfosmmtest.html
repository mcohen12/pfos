<!DOCTYPE html>
<html>
 <head>
  <title>PFOS JSON MM- Using chart.js</title>
  <meta charset="utf-8">
  <script src="https://www.weather.gov/js/jquery-1.10.2.min.js"></script>
  <script src="https://www.weather.gov/js/jquery-ui-1.10.3.custom.min.js"></script>
  <link crossorigin="" href="https://unpkg.com/leaflet@1.3.3/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" rel="stylesheet" />
  <script src="https://unpkg.com/leaflet@1.3.3/dist/leaflet.js" integrity="sha512-tAGcCfR4Sc5ZP5ZoVz0quoZDYX5aCtEm/eu1KhSLj2c9eFrylXZknQYmxUssFaVJKvvc0dJQixhGjG2yXWiV9Q==" crossorigin=""></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script> 
 </head>
 <body>
  <h1 align="center">Use the map below to view forecast point PFOS Graphics</h1>
  <div align="center" id="mapid" style="width: 100%; height: 500px;">&nbsp;</div>
  <!--script src ="data.js"></script -->

<script>
   var riverPoints = [{id:"drtn8",latLon:[48.572480,-97.148],name:"Red River at Drayton",url:"https://water.weather.gov/ahps2/probability_information.php?wfo=fgf&gage=drtn8&graph_id=2"},
    {id:"egfm5",latLon:[47.933307,-97.037085],name:"Red River at East Grand Forks",url:"https://water.weather.gov/ahps2/probability_information.php?wfo=fgf&gage=egfm5&graph_id=2"},
    {id:"fgon8",latLon:[46.861725,-96.783593],name:"Red River at Fargo",url:"https://water.weather.gov/ahps2/probability_information.php?wfo=fgf&gage=fgon8&graph_id=2"},
    {id:"hiln8",latLon:[47.352608,-96.844130],name:"Red River at Halsted",url:"https://water.weather.gov/ahps2/probability_information.php?wfo=fgf&gage=hiln8&graph_id=2"},
    {id:"hicn8",latLon:[46.659278,-96.797085],name:"Red River at Hickson",url:"https://water.weather.gov/ahps2/probability_information.php?wfo=fgf&gage=hicn8&graph_id=2"},
    {id:"clxm5",latLon:[47.611944,-96.814444],name:"Sand Hill River at Climax",url:"https://water.weather.gov/ahps2/probability_information.php?wfo=fgf&gage=clxm5&graph_id=2"},
    {id:"hndm5",latLon:[47.268056,-96.797222],name:"Wild Rice River (MN) at Hendrum",url:"https://water.weather.gov/ahps2/probability_information.php?wfo=fgf&gage=hndm5&graph_id=2"}
   ];
    
 var histCrests=[];
 var probOfExceed=[];
 var probOfExceedFS=[];
 function preLoad(){
  var req = new XMLHttpRequest();
  req.open('GET','https://cors-anywhere.herokuapp.com/https://www.weather.gov/source/aprfc/histCrestsfgf.json',true);
  req.addEventListener('load',function(){
   if(req.status >= 200 && req.status < 400){
    console.log("hello it worked");
    var json = (JSON.parse(req.responseText)).features;
    console.log("json length is "+json.length);
    for (var i=0;i<json.length;i++)
     histCrests[i] = json[i].properties;
   }
   else
    console.log("had an error");
  });
  req.send();
  var req2 = new XMLHttpRequest();
  req2.open('GET','https://cors-anywhere.herokuapp.com/https://www.weather.gov/source/ncrfc/CS_distributions.json',true);
  req2.addEventListener('load',function(){
   if(req2.status >= 200 && req2.status < 400){
    console.log("hello it worked");
    probOfExceedFS = JSON.parse(req2.responseText);
   }
   else
    console.log("had a problem with grabbing from NCRFC");
  });
  req2.send();
 
  var req3 = new XMLHttpRequest();
  req3.open('GET','https://cors-anywhere.herokuapp.com/https://www.weather.gov/source/ncrfc/CS_percentiles.json',true);
  req3.addEventListener('load',function(){
   if(req3.status >= 200 && req3.status < 400){
    console.log("got the percentiles");
    probOfExceed = JSON.parse(req3.responseText);
   }
   else
    console.log("had problem grabbing percentiles");
  });
  req3.send();
 }

   
  

document.addEventListener("DOMContentLoaded", preLoad);
 
  //  for (obj in json){
//console.log(json.features[0].properties.gage

 function makeBox(point,pointName,pointID){
  var req = new XMLHttpRequest();
  var reqLink = "https://water.weather.gov/ahps2/hydrograph_to_xml.php?output=xml&gage="+pointID;
  req.open('GET',reqLink,true);
  req.addEventListener('load', function(){
   if (req.status == 200){
    parser = new DOMParser();
    xmlDoc = parser.parseFromString(req.responseText, "text/xml");
    var sigStages = xmlDoc.querySelector("sigstages");
    var actionHeight = parseInt(sigStages.querySelector("action").textContent);
    var minorHeight = parseInt(sigStages.querySelector("flood").textContent);
    var moderateHeight = parseInt(sigStages.querySelector("moderate").textContent);
    var majorHeight = parseInt(sigStages.querySelector("major").textContent);
    //var recordHeight = parseInt(sigStages.querySelector("record").textContent);
    var observed = parseInt((xmlDoc.querySelector("observed datum primary")).textContent);
    var dateObserved = new Date((xmlDoc.querySelector("observed datum valid")).textContent);
    
//    console.log("recordHeight is "+recordHeight);
    console.log("observed is "+observed);
    setGraphParams(point,pointName,pointID,actionHeight,minorHeight,moderateHeight,majorHeight,observed,dateObserved);
   }
   else
    console.log("got an error");
  });
  req.send();
 }
 function setGraphParams(point,pointName,pointID,actionHeight,minorHeight,moderateHeight,majorHeight,observedHeight,dateObserved){

  tester = document.getElementById('highContainer');
  var data = [];
  //find station in probOfExceed
  let i=0; let found=false;
  while(i<probOfExceed.length && !found){
   if((probOfExceed[i].id).toUpperCase() == pointID.toUpperCase())
    found=true;
   else
    i++;
  }
  if(found){
   for(let j=0;j<probOfExceed[i].exceedance.length;j++){
    let height = (Number(probOfExceed[i].exceedance[j].height)).toFixed(1);
    let percent = Number(probOfExceed[i].exceedance[j].percent);
    let exceed0 = { showlegend: false, x: [44], y: [height], mode: 'text', text: [height], legendgroup: 'exceed'+percent,hoverinfo:"none"};
    let exceed1 = { showlegend: true, x: [46,49], y: [height,height], mode: 'lines', line:{color:'rgb(34,23,77)'}, legendgroup: 'exceed'+percent, name: percent,hoverinfo:"none"};
    let exceed2 = { showlegend: false, x: [51], y: [height], mode: 'text', text: [percent+"%"], legendgroup: 'exceed'+percent,hoverinfo:"none"};
    data.push(exceed0,exceed1,exceed2);
   }
  }
  //find station in probOfExceedFS
  i=0;found=false;
  while(i<probOfExceedFS.length && !found){
   if((probOfExceedFS[i].id).toUpperCase() == pointID.toUpperCase())
    found=true;
   else
    i++;
  }
  if(found){
   for (j=0; j<probOfExceedFS[i].exceedance.length;j++){
    let height = Number(probOfExceedFS[i].exceedance[j].height);
    let percent = Number(probOfExceedFS[i].exceedance[j].percent);
    let exceed0 = { showlegend: false, x: [45], y: [height], mode: 'text', text: [height], legendgroup: 'exceed'+percent,hoverinfo:"none"};
    let exceed1 = { showlegend: true, x: [46,49], y: [height,height], mode: 'lines', line:{color:'rgb(34,23,77)'}, legendgroup: 'exceed'+percent, name: percent,hoverinfo:"none"};
    let exceed2 = { showlegend: false, x: [50], y: [height], mode: 'text', text: [percent], legendgroup: 'exceed'+percent,hoverinfo:"none"};
   //show every other if there's more than 5
   // if (probOfExceedFS[i].exceedance.length > 5)
  //   if (i%7 != 0)//if ([2,5,10,15,20,25].indexOf(percent) == -1)
   // exceed0.visible = exceed1.visible = exceed2.visible = "legendonly";
   data.push(exceed0,exceed1,exceed2);
   }
  }

 // for (var j=0; j<riverData[i].notableCrests.length;j++){
 let k=0; found=false;
 while(k<histCrests.length && !found){
  if ((histCrests[k].gage).toUpperCase() == pointID.toUpperCase())
   found=true;
  else
   k++;
 }
//need exception handling for this stuff
 var recordHeight = Number(histCrests[k].historicCrests[0].height); var recordDay = histCrests[k].historicCrests[0].day;

 for(i=1;i<histCrests[k].historicCrests.length;i++){
  var height = Number(histCrests[k].historicCrests[i].height); var day = histCrests[k].historicCrests[i].day;
  var notable0 = { showlegend:false, x: [88], y:[height], mode: 'text', text: [height], legendgroup:'notable',hoverinfo:"none"}; 
   var notable1 = { showlegend:false, x: [90, 93], y: [height, height], mode: 'lines',legendgroup:'notable', hoverinfo:"none", line: { color: 'rgb(0,0,0)', width:1} };
   //make legend visible for one
   if (i==1){
    notable1.showlegend = true;
    notable1.name = "Notable Crests";
   }
   var notable2 = { showlegend:false, x: [93], y:[height], mode: 'text', text: day,legendgroup:'notable',hoverinfo:"none", textposition:'right' };
   data.push(notable0, notable1, notable2);
  // data.push(notable0);
  }
  var record = {
   showlegend: false,
   x: [-10000, 10000], y: [recordHeight,recordHeight], mode: 'lines+text', text: ['Record '+recordHeight+' ft '+ recordDay], textposition: 'top right',hoverinfo:"none",
   line: { dash: 'dot', width: 2, color: 'rgb(0,0,0)'
   }
  };
  var action = {
   showlegend: false,
   x: [-10000, 10000], y: [actionHeight,actionHeight], mode: 'lines', 
   line: {
    color: 'rgb(158,191,57)'
   }
  };
  var minor = {
   showlegend: false,
   x: [-10000,10000],
   y: [minorHeight,minorHeight],
   mode: 'lines',
   line: {
    color: 'rgb(237,176,7)', width: 2
   }
  };
  var moderate = {
   showlegend: false, x: [-10000, 10000], y: [moderateHeight,moderateHeight],mode: 'lines',
   line: { color: 'rgb(237,53,17)', width: 2}
  };
  var major = {
   showlegend: false,
   x: [-10000,10000],
   y: [majorHeight,majorHeight],
   mode: 'lines',
   line: {
    color: 'rgb(179,57,219)',
    width: 2
   }
  };
  data.push(action,minor,moderate,major,record);
  var layout = {
   title: '2020 Spring Flood Outlook for '+pointName,
   //showlegend: true, 
   traceorder: 'grouped',
   dragmode: 'pan',
   margin: { l: 50, r:100 },
   yaxis: {
    range: [actionHeight-10,recordHeight+10],
    title: 'River Stage (ft)',
    ticks: 'outside',
    linecolor: 'black',
    linewidth: 2,
    mirror: true,
    tickfont: {
     family: 'Arial',
     size: 14
    }
   },
   xaxis: {
    showgrid: false,
    showline: true,
    linecolor: 'black',
    linewidth: 2,
    mirror: true,
    showticklabels: false,
    range: [0,100]
   },
   xaxis2: {
    showgrid: true,
    range: [0,1]
   },
   annotations: [
   {
    xref: 'paper',
    yref: 'paper', 
   // xref: 'x',
   // yref: 'paper',
    x: 1,
    xanchor: 'left',
    y: 1,
    textangle:0,
    yanchor: 'middle',
    text: 'Probability of Exceedence',
    showarrow: false 
   },
   {
    xref: 'paper',yref: 'paper',x: 0.01,y:0.04, xanchor: 'left',textangle:0,yanchor: 'middle',text: '<b>River Level: '+observedHeight+' ft as of '+dateObserved+'</b> ',showarrow: false,hoverinfo:"none"
   },
   {xref: 'paper',yref: 'y', x:0, y: actionHeight, xanchor: 'left', textangle: 0, yanchor:'middle',text: '<b>Action ('+actionHeight+' ft)</b>',showarrow:false,hoverinfo:'none',textposition:'top left',bgcolor:'rgb(158,191,57)',bordercolor:'rgb(0,0,0)',font: { color: "white", size:17, family: 'Arial,Helvetica,sans serif'}
   },
   {xref: 'paper',yref: 'y', x:0.1, y: minorHeight, xanchor: 'left', textangle: 0, yanchor:'middle',text: '<b>Minor ('+minorHeight+' ft)</b>',showarrow:false,hoverinfo:'none',textposition:'top left',bgcolor:'rgb(237,176,7)',bordercolor:'rgb(0,0,0)',font: { color: "white", size:17, family: 'Arial,Helvetica,sans serif'}
   },
   {xref: 'paper',yref: 'y', x:0, y: moderateHeight, xanchor: 'left', textangle: 0, yanchor:'middle',text: '<b>Moderate ('+moderateHeight+' ft)</b>',showarrow:false,hoverinfo:'none',textposition:'top left',bgcolor:'rgb(237,53,17)',bordercolor:'rgb(0,0,0)',font: { color: "white", size:17, family: 'Arial,Helvetica,sans serif'}
   },
   {xref: 'paper',yref: 'y', x:0.1, y: majorHeight, xanchor: 'left', textangle: 0, yanchor:'middle',text: '<b>Major ('+majorHeight+' ft)</b>',showarrow:false,hoverinfo:'none',textposition:'top left',bgcolor:'rgb(179,57,219)',bordercolor:'rgb(0,0,0)',font: { color: "white", size:17, family: 'Arial,Helvetica,sans serif'}
   },
   {xref: 'paper',yref:'y',x:0.3, y:recordHeight, xanchor: 'left', textangle: 0, yanchor:'middle',text: 'Record '+recordHeight+' ft '+ recordDay, showarrow:false,hoverinfo:'none',textposition:'top left',bgcolor:'white',font: { color: "navy", size:15, family: 'Arial, Helvetica, sans serif'}
   }

   ]
  };
   
  Plotly.newPlot(tester, data, layout, {responsive:true,scrollZoom:true,modeBarButtonsToRemove: ['select2d','pan2d','lasso2d','hoverClosestCartesian','hoverCompareCartesian','toggleSpikelines']});

 tester.on('plotly_relayout',
  function(){
   alert( 'ZOOM\n\n');
  });
 }




    var mymap = L.map('mapid').setView([47.925, -97.032], 7);


    // These control the height and width of the image and pop up box.
    // "Height" will control the height of both the image and the pop up box.
    // Make sure that "Width" and "popUpWidth" match to make it look nice.  
 /*   var Height      = "450";
    var Width       = "450"; 
    var popUpWidth  = "450"; 
*/

var Height = "800";
    var Width       = "450"; 
    var popUpWidth  = "450"; 


    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
            '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        id: 'mapbox.streets'
    }).addTo(mymap);
    


    // PFOS Image Sources - note, must be uploaded to the CMS server!






    // Markers and pop up windows. 





    // Red River
 

for (var i=0;i<riverPoints.length;i++){
 
 let name=riverPoints[i].name;
 let id=riverPoints[i].id;
 let newPoint = L.marker(riverPoints[i].latLon,{
    color:'black',
 }).on('click',function(e){makeBox(e,name,id);}).addTo(mymap);
} 


 


</script>

  <section id="graphicHome">
   <div style="height:800px;" id="highContainer"></div>
   <!--div id="highContainer"></div-->
  </section>
  <div style="clear:both"></div> 

 </body>
</html>

 
