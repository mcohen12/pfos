<!DOCTYPE html>
<html>
 <head>
  <title>PFOS JSON MM- Using chart.js</title>
  <meta charset="utf-8">
  <script src="https://www.weather.gov/js/jquery-1.10.2.min.js"></script>
  <script src="https://www.weather.gov/js/jquery-ui-1.10.3.custom.min.js"></script>
  <link crossorigin="" href="https://unpkg.com/leaflet@1.3.3/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" rel="stylesheet" />
  <script src="https://unpkg.com/leaflet@1.3.3/dist/leaflet.js" integrity="sha512-tAGcCfR4Sc5ZP5ZoVz0quoZDYX5aCtEm/eu1KhSLj2c9eFrylXZknQYmxUssFaVJKvvc0dJQixhGjG2yXWiV9Q==" crossorigin=""></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script> 
 </head>
 <body>
  <h1 align="center">Use the map below to view forecast point PFOS Graphics</h1>
  <div align="center" id="mapid" style="width: 100%; height: 500px;">&nbsp;</div>
  <script src ="data.js"></script>

<script>

 function makeBox(point,pointName,pointID){
  var req = new XMLHttpRequest();
  var reqLink = "https://water.weather.gov/ahps2/hydrograph_to_xml.php?output=xml&gage="+pointID;
  req.open('GET',reqLink,true);
  req.addEventListener('load', function(){
   if (req.status == 200){
    parser = new DOMParser();
    xmlDoc = parser.parseFromString(req.responseText, "text/xml");
    var sigStages = xmlDoc.querySelector("sigstages");
    var actionHeight = parseInt(sigStages.querySelector("action").textContent);
    var minorHeight = parseInt(sigStages.querySelector("flood").textContent);
    var moderateHeight = parseInt(sigStages.querySelector("moderate").textContent);
    var majorHeight = parseInt(sigStages.querySelector("major").textContent);
    var recordHeight = parseInt(sigStages.querySelector("record").textContent);
    var observed = parseInt((xmlDoc.querySelector("observed datum primary")).textContent);
    
    console.log("recordHeight is "+recordHeight);
    console.log("observed is "+observed);
    makeGraph(point,pointName,pointID,actionHeight,minorHeight,moderateHeight,majorHeight,recordHeight,observed);
   }
   else
    console.log("got an error");
  });
  req.send();
 }
 function makeGraph(point,pointName,pointID,actionHeight,minorHeight,moderateHeight,majorHeight,recordHeight,observedHeight){

  tester = document.getElementById('highContainer');
  var i=0;
  var id = pointID;
  //find the right river
  while (id != riverData[i].id && i < riverData.length)
   i++;
  
  var data = [];
  
  for (var k=0; k<percentExceed[i].exceedance.length;k++){
   var height = percentExceed[i].exceedance[k].height;
   var percent = percentExceed[i].exceedance[k].percent+"%";
   var exceed0 = { showlegend: false, x: [45], y: [height], mode: 'text', text: [height], legendgroup: 'exceed'+percent,hoverinfo:"none"};
   var exceed1 = { showlegend: true, x: [46,49], y: [height,height], mode: 'lines', line:{color:'rgb(34,23,77)'}, legendgroup: 'exceed'+percent, name: percent,hoverinfo:"none"};
   var exceed2 = { showlegend: false, x: [50], y: [height], mode: 'text', text: [percent], legendgroup: 'exceed'+percent,hoverinfo:"none"};
   if (["5%","50%","95%"].indexOf(percent) == -1) //default to only show 5, 50, and 95%
    exceed0.visible = exceed1.visible = exceed2.visible = "legendonly";
   data.push(exceed0,exceed1,exceed2);
  }
  
  for (var j=0; j<riverData[i].notableCrests.length;j++){
   var height = riverData[i].notableCrests[j].height;
   var notable0 = { showlegend:false, x: [88], y:[height], mode: 'text', text: [height], legendgroup:'notable',hoverinfo:"none"}; 
   var notable1 = { showlegend:false, x: [90, 93], y: [height, height], mode: 'lines',legendgroup:'notable', hoverinfo:"none", line: { color: 'rgb(0,0,0)', width:1} };
   //make legend visible for one
   if (j==0){
    notable1.showlegend = true;
    notable1.name = "Notable Crests";
   }
   var notable2 = { showlegend:false, x: [93], y:[height], mode: 'text', text: [riverData[i].notableCrests[j].year],legendgroup:'notable',hoverinfo:"none", textposition:'right' };
   data.push(notable0, notable1, notable2);
  // data.push(notable0);
  }
  var record = {
   showlegend: false,
   x: [0, 98], y: [recordHeight,recordHeight], mode: 'lines+text', text: ['Record '+recordHeight+' ft '+riverData[i].record.year], textposition: 'top right',hoverinfo:"none",
   line: { dash: 'dot', width: 2, color: 'rgb(0,0,0)'
   }
  };
  var action = {
   showlegend: false,
   x: [-10000, 10000], y: [actionHeight,actionHeight], mode: 'lines', 
   line: {
    color: 'rgb(158,191,57)'
   }
  };
  var minor = {
   showlegend: false,
   x: [-10000,10000],
   y: [minorHeight,minorHeight],
   mode: 'lines',
   line: {
    color: 'rgb(237,176,7)', width: 2
   }
  };
  var moderate = {
   showlegend: false, x: [-10000, 10000], y: [moderateHeight,moderateHeight],mode: 'lines',
   line: { color: 'rgb(237,53,17)', width: 2}
  };
  var major = {
   showlegend: false,
   x: [-10000,10000],
   y: [majorHeight,majorHeight],
   mode: 'lines',
   line: {
    color: 'rgb(179,57,219)',
    width: 2
   }
  };
  data.push(action,minor,moderate,major,record);
  var layout = {
   title: '2020 Spring Flood Outlook for '+pointName,
   //showlegend: true, 
   traceorder: 'grouped',
   dragmode: 'pan',
   margin: { l: 50, r:100 },
   yaxis: {
    range: [actionHeight-10,recordHeight+10],
    title: 'River Stage (ft)',
    ticks: 'outside',
    linecolor: 'black',
    linewidth: 2,
    mirror: true,
    tickfont: {
     family: 'Arial',
     size: 14
    }
   },
   xaxis: {
    showgrid: false,
    showline: true,
    linecolor: 'black',
    linewidth: 2,
    mirror: true,
    showticklabels: false,
    range: [0,100]
   },
   xaxis2: {
    showgrid: true,
    range: [0,1]
   },
   annotations: [
   {
    xref: 'paper',
    yref: 'paper', 
   // xref: 'x',
   // yref: 'paper',
    x: 1,
    xanchor: 'left',
    y: 1,
    textangle:0,
    yanchor: 'middle',
    text: 'Probability of Exceedence',
    showarrow: false 
   },
   {
    xref: 'paper',
    yref: 'paper',
    x: 0.2,
    y: 0.05,
    xanchor: 'left',
    textangle:0,
    yanchor: 'middle',
    text: 'River Level: '+observedHeight+' ft as of __ need to get day and convert from UTC ',
    showarrow: false,hoverinfo:"none"
   },
   {xref: 'paper',yref: 'y', x:0, y: actionHeight, xanchor: 'left', textangle: 0, yanchor:'middle',text: 'Action ('+actionHeight+' ft)',showarrow:false,hoverinfo:'none',textposition:'top left',bgcolor:'rgb(158,191,57)',bordercolor:'rgb(0,0,0)'
   },
   {xref: 'paper',yref: 'y', x:0.1, y: minorHeight, xanchor: 'left', textangle: 0, yanchor:'middle',text: 'Minor ('+minorHeight+' ft)',showarrow:false,hoverinfo:'none',textposition:'top left',bgcolor:'rgb(237,176,7)',bordercolor:'rgb(0,0,0)'
   },
   {xref: 'paper',yref: 'y', x:0, y: moderateHeight, xanchor: 'left', textangle: 0, yanchor:'middle',text: 'Moderate ('+moderateHeight+' ft)',showarrow:false,hoverinfo:'none',textposition:'top left',bgcolor:'rgb(237,53,17)',bordercolor:'rgb(0,0,0)'
   },
   {xref: 'paper',yref: 'y', x:0.1, y: majorHeight, xanchor: 'left', textangle: 0, yanchor:'middle',text: 'Major ('+majorHeight+' ft)',showarrow:false,hoverinfo:'none',textposition:'top left',bgcolor:'rgb(179,57,219)',bordercolor:'rgb(0,0,0)'
   }
   ]
  };
   
  Plotly.newPlot(tester, data, layout, {responsive:true,scrollZoom:true,modeBarButtonsToRemove: ['select2d','pan2d','lasso2d','hoverClosestCartesian','hoverCompareCartesian','toggleSpikelines']});
 }




    var mymap = L.map('mapid').setView([47.925, -97.032], 7);


    // These control the height and width of the image and pop up box.
    // "Height" will control the height of both the image and the pop up box.
    // Make sure that "Width" and "popUpWidth" match to make it look nice.  
    var Height      = "450";
    var Width       = "450"; 
    var popUpWidth  = "450"; 


    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
            '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        id: 'mapbox.streets'
    }).addTo(mymap);
    


    // PFOS Image Sources - note, must be uploaded to the CMS server!






    // Markers and pop up windows. 





    // Red River
 

for (var i=0;i<riverPoints.length;i++){
 
 let name=riverPoints[i].name;
 let id=riverPoints[i].id;
 let newPoint = L.marker(riverPoints[i].latLon,{
    color:'black',
 }).on('click',function(e){makeBox(e,name,id);}).addTo(mymap);
} 


 


</script>

  <section id="graphicHome">
   <div id="highContainer"></div>
  </section>
  <div style="clear:both"></div> 

 </body>
</html>

 
